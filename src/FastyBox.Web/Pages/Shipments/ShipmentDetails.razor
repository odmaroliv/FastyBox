@page "/shipments/{Id:guid}"
@using FastyBox.Application.Common.Interfaces
@using FastyBox.Application.Shipments.Queries.GetShipmentById
@using FastyBox.Domain.Enums
@using FastyBox.Web.Resources
@using FastyBox.Web.Services
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.EntityFrameworkCore
@using Microsoft.Extensions.Localization
@using Microsoft.JSInterop
@using MudBlazor
@using SendGrid.Helpers.Mail
@inject IStringLocalizer<SharedResource> L
@inject FastyBox.Web.Services.IShipmentService ShipmentService
@inject IUserService UserService
@inject IStripeService StripeService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime

<PageTitle>@L["ShipmentDetails"] - @L["AppName"]</PageTitle>

@if (_isLoading)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else if (_shipment != null)
{
    <MudContainer MaxWidth="MaxWidth.ExtraLarge">
        <MudGrid>
            <MudItem xs="12" Class="d-flex justify-space-between align-center">
                <MudText Typo="Typo.h4">@L["ShipmentDetails"] - @_shipment.TrackingNumber</MudText>
                <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@(() => NavigationManager.NavigateTo("/shipments"))">
                    @L["Back to List"]
                </MudButton>
            </MudItem>
            
            <MudItem xs="12" md="8">
                <MudPaper Class="pa-4 mb-4">
                    <MudGrid>
                        <MudItem xs="12" md="4">
                            <MudText Typo="Typo.subtitle2">@L["Status"]</MudText>
                            <ShipmentStatusBadge Status="@_shipment.Status" />
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudText Typo="Typo.subtitle2">@L["Type"]</MudText>
                            <MudText>@(_shipment.Type == ShipmentType.Forwarding ? L["TypeForwarding"] : L["TypeCommercialImport"])</MudText>
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudText Typo="Typo.subtitle2">@L["CreatedAt"]</MudText>
                            <MudText>@_shipment.CreatedAt.ToLocalTime().ToString("g")</MudText>
                        </MudItem>
                        
                        <MudItem xs="12" md="4">
                            <MudText Typo="Typo.subtitle2">@L["DeclaredValue"]</MudText>
                            <MudText>$@_shipment.DeclaredValue.ToString("N2")</MudText>
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudText Typo="Typo.subtitle2">@L["Weight"]</MudText>
                            <MudText>@_shipment.Weight kg</MudText>
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudText Typo="Typo.subtitle2">@L["CourierTrackingNumber"]</MudText>
                            <MudText>@(_shipment.CourierTrackingNumber ?? "-")</MudText>
                        </MudItem>
                        
                        <MudItem xs="12">
                            <MudText Typo="Typo.subtitle2">@L["Description"]</MudText>
                            <MudText>@_shipment.Description</MudText>
                        </MudItem>
                    </MudGrid>
                </MudPaper>
                
                <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
                    <MudTabPanel Text="@L["Items"]" Icon="@Icons.Material.Filled.Inventory">
                        @if (_shipment.Items.Count > 0)
                        {
                           <MudTable Items="@_shipment.Items" Hover="true" Breakpoint="Breakpoint.Sm">
                                <HeaderContent>
                                    <MudTh>@L["Name"]</MudTh>
                                    <MudTh>@L["Quantity"]</MudTh>
                                    <MudTh>@L["UnitPrice"]</MudTh>
                                    <MudTh>@L["TotalPrice"]</MudTh>
                                    <MudTh>@L["Weight"]</MudTh>
                                </HeaderContent>
                                                                <RowTemplate>
                                        <MudTr>
                                            <MudTd DataLabel="@L["Name"]">
                                                <div>
                                                    <div>@context.Name</div>
                                                @if (!string.IsNullOrEmpty(context.Url))
                                                {
                                                    <MudLink Href="@context.Url" Target="_blank" Typo="Typo.caption">@L["View"]</MudLink>
                                                }
                                            </div>
                                        </MudTd>
                                        <MudTd DataLabel="@L["Quantity"]">@context.Quantity</MudTd>
                                            <MudTd DataLabel="@L["UnitPrice"]">$@context.UnitPrice.ToString("N2")</MudTd>
                                            <MudTd DataLabel="@L["TotalPrice"]">$@context.TotalPrice.ToString("N2")</MudTd>
                                            <MudTd DataLabel="@L["Weight"]">@($"{context.Weight} kg")</MudTd>
                                        </MudTr>
                                    </RowTemplate>

                                    </MudTable>
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Info">@L["No items found."]</MudAlert>
                        }
                    </MudTabPanel>
                    
                    <MudTabPanel Text="@L["Documents"]" Icon="@Icons.Material.Filled.Description">
                        <div class="mb-4">
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Upload"
                                      OnClick="OpenUploadDialog">
                                @L["UploadDocument"]
                            </MudButton>
                        </div>
                        
                        @if (_shipment.Documents.Count > 0)
                        {
                           <MudTable Items="@_shipment.Documents" Hover="true" Breakpoint="Breakpoint.Sm">
                                <HeaderContent>
                                    <MudTh>@L["Type"]</MudTh>
                                    <MudTh>@L["FileName"]</MudTh>
                                    <MudTh>@L["UploadedAt"]</MudTh>
                                    <MudTh></MudTh>
                                </HeaderContent>
                                    <RowTemplate>
                                        <MudTr>
                                            <MudTd DataLabel="@L["Type"]">@GetDocumentTypeName(@context.Type)</MudTd>
                                            <MudTd DataLabel="@L["FileName"]">@context.FileName</MudTd>
                                            <MudTd DataLabel="@L["UploadedAt"]">@context.CreatedAt.ToLocalTime().ToString("g")</MudTd>
                                            <MudTd>
                                                <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small"
                                                           Href="@context.PublicUrl" Target="_blank">
                                                    @L["View"]
                                            </MudButton>
                                        </MudTd>
                                    </MudTr>
                                </RowTemplate>

                                    </MudTable>
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Info">@L["No documents found. Please upload the required documents."]</MudAlert>
                        }
                    </MudTabPanel>
                    
                    <MudTabPanel Text="@L["History"]" Icon="@Icons.Material.Filled.History">
                        @if (_shipment.StatusHistory.Count > 0)
                        {
                            <MudTimeline>
                                @foreach (var history in _shipment.StatusHistory.OrderByDescending(h => h.CreatedAt))
                                {
                                    <MudTimelineItem Color="@GetTimelineColor(history.NewStatus)" Elevation="0">
                                        <ItemOpposite>
                                            <MudText Typo="Typo.body2">@history.CreatedAt.ToLocalTime().ToString("g")</MudText>
                                        </ItemOpposite>
                                        <ItemContent>
                                            <MudText Typo="Typo.h6">@GetStatusText(history.NewStatus)</MudText>
                                            @if (!string.IsNullOrEmpty(history.Notes))
                                            {
                                                <MudText Typo="Typo.body2">@history.Notes</MudText>
                                            }
                                        </ItemContent>
                                    </MudTimelineItem>
                                }
                            </MudTimeline>
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Info">@L["No history found."]</MudAlert>
                        }
                    </MudTabPanel>
                    
                    <MudTabPanel Text="@L["Notes"]" Icon="@Icons.Material.Filled.Notes">
                        <div class="mb-4">
                            <MudTextField @bind-Value="_newNote" Label="@L["Add a note"]" Lines="3" />
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mt-2"
                                      OnClick="AddNote" Disabled="@string.IsNullOrWhiteSpace(_newNote)">
                                @L["AddNote"]
                            </MudButton>
                        </div>
                        
                        @if (_shipment.Notes.Count > 0)
                        {
                            <MudList T="object">
                                @foreach (var note in _shipment.Notes.OrderByDescending(n => n.CreatedAt))
                                {
                                    <MudListItem>
                                        <div class="d-flex flex-column">
                                            <MudText>@note.Note</MudText>
                                            <div class="d-flex align-center">
                                                <MudText Typo="Typo.caption">
                                                    @(note.IsSystemGenerated ? L["System"] : note.User?.FullName)
                                                </MudText>
                                                <MudText Typo="Typo.caption" Class="ml-2">
                                                    @note.CreatedAt.ToLocalTime().ToString("g")
                                                </MudText>
                                            </div>
                                        </div>
                                    </MudListItem>
                                    <MudDivider />
                                }
                            </MudList>
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Info">@L["No notes found."]</MudAlert>
                        }
                    </MudTabPanel>
                </MudTabs>
            </MudItem>
            
            <MudItem xs="12" md="4">
                <MudPaper Class="pa-4 mb-4">
                    <MudText Typo="Typo.h6" Class="mb-4">@L["Payment"]</MudText>
                    
                    @if (_shipment.IsPaid)
                    {
                        <MudAlert Severity="Severity.Success" Class="mb-4">@L["This shipment has been paid."]</MudAlert>
                    }
                    else if (_shipment.Status == ShipmentStatus.AwaitingPayment)
                    {
                        <MudAlert Severity="Severity.Warning" Class="mb-4">@L["Payment required to proceed."]</MudAlert>
                    }

                    <MudList T="object" Clickable="false">
                        <MudListItem>
                            <div class="d-flex justify-space-between w-100">
                                <MudText>@L["ShippingCost"]</MudText>
                                <MudText>$@_shipment.ShippingCost.ToString("N2")</MudText>
                            </div>
                        </MudListItem>
                        <MudListItem>
                            <div class="d-flex justify-space-between w-100">
                                <MudText>@L["ServiceFee"]</MudText>
                                <MudText>$@_shipment.ServiceFee.ToString("N2")</MudText>
                            </div>
                        </MudListItem>
                        <MudDivider />
                        <MudListItem>
                            <div class="d-flex justify-space-between w-100">
                                <MudText Typo="Typo.h6">@L["TotalCost"]</MudText>
                                <MudText Typo="Typo.h6">$@_shipment.TotalCost.ToString("N2")</MudText>
                            </div>
                        </MudListItem>
                    </MudList>
                    
                    @if (!_shipment.IsPaid && _shipment.Status == ShipmentStatus.AwaitingPayment && _shipment.TotalCost > 0)
                    {
                        <MudButton Variant="Variant.Filled" Color="Color.Success" FullWidth="true" Class="mt-4"
                                  OnClick="InitiatePayment" Disabled="_isProcessingPayment">
                            @if (_isProcessingPayment)
                            {
                                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                                <MudText Class="ms-2">@L["Processing"]</MudText>
                            }
                            else
                            {
                                @L["PayNow"]
                            }
                        </MudButton>
                    }
                </MudPaper>
                
                <MudPaper Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-4">@L["Actions"]</MudText>
                    
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" FullWidth="true" Class="mb-2"
                              StartIcon="@Icons.Material.Filled.ContentCopy"
                              OnClick="CopyTrackingNumber">
                        @L["Copy Tracking Number"]
                    </MudButton>
                    
                    @if (_shipment.Status == ShipmentStatus.Draft)
                    {
                        <MudButton Variant="Variant.Outlined" Color="Color.Success" FullWidth="true" Class="mb-2"
                                  StartIcon="@Icons.Material.Filled.Send"
                                  OnClick="@(() => UpdateStatus(ShipmentStatus.Submitted))">
                            @L["Submit Shipment"]
                        </MudButton>
                    }
                    
                    @if (_shipment.Status is ShipmentStatus.Draft or ShipmentStatus.Submitted)
                    {
                        <MudButton Variant="Variant.Outlined" Color="Color.Error" FullWidth="true" Class="mb-2"
                                  StartIcon="@Icons.Material.Filled.Cancel"
                                  OnClick="@(() => UpdateStatus(ShipmentStatus.Cancelled))">
                            @L["Cancel Shipment"]
                        </MudButton>
                    }
                </MudPaper>
            </MudItem>
        </MudGrid>
    </MudContainer>
    
    <MudDialog @bind-IsVisible="_isUploadDialogVisible" Options="new DialogOptions { CloseOnEscapeKey = true }">
        <TitleContent>
            <MudText Typo="Typo.h6">@L["UploadDocument"]</MudText>
        </TitleContent>
        <DialogContent>
            <MudForm @ref="_uploadForm" @bind-IsValid="@_isUploadFormValid">
                <MudSelect T="DocumentType" Label="@L["DocumentType"]" @bind-Value="_documentType" Required="true"
                          RequiredError="@L["ErrorFieldRequired"]">
                    <MudSelectItem Value="@DocumentType.Invoice">@L["Invoice"]</MudSelectItem>
                    <MudSelectItem Value="@DocumentType.PaymentProof">@L["PaymentProof"]</MudSelectItem>
                    <MudSelectItem Value="@DocumentType.ProductImage">@L["ProductImage"]</MudSelectItem>
                    <MudSelectItem Value="@DocumentType.CustomsDeclaration">@L["CustomsDeclaration"]</MudSelectItem>
                    <MudSelectItem Value="@DocumentType.OtherDocumentation">@L["OtherDocumentation"]</MudSelectItem>
                </MudSelect>
                
                <MudTextField T="string" Label="@L["Notes"]" @bind-Value="_documentNotes" Lines="3" />
                
                <InputFile id="fileInput" OnChange="OnInputFileChange" hidden accept=".pdf,.jpg,.jpeg,.png" />
                
                <div class="d-flex align-center justify-space-between mt-4">
                    <div>
                        @if (_selectedFile != null)
                        {
                            <MudText Typo="Typo.body2">@_selectedFile.FileName</MudText>
                            <MudText Typo="Typo.caption">@(_selectedFile.Size / 1024) KB</MudText>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2">@L["No file selected"]</MudText>
                        }
                    </div>
                    
                    <MudButton HtmlTag="label" Variant="Variant.Filled" Color="Color.Primary"
                              StartIcon="@Icons.Material.Filled.CloudUpload" for="fileInput">
                        @L["Choose File"]
                    </MudButton>
                </div>
            </MudForm>
        </DialogContent>
        <DialogActions>
            <MudButton Variant="Variant.Text" Color="Color.Secondary" OnClick="@(() => _isUploadDialogVisible = false)">
                @L["Cancel"]
            </MudButton>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="@(!_isUploadFormValid || _selectedFile == null || _isUploading)"
                      OnClick="UploadDocument">
                @if (_isUploading)
                {
                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                    <MudText Class="ms-2">@L["Uploading"]</MudText>
                }
                else
                {
                    @L["Upload"]
                }
            </MudButton>
        </DialogActions>
    </MudDialog>
    
    <div id="payment-element-container" class="@(_isStripeInitialized ? "d-block" : "d-none")"></div>
}
else
{
    <MudAlert Severity="Severity.Error">@L["Shipment not found."]</MudAlert>
}

@code {
    [Parameter]
    public Guid Id { get; set; }

    private Shipment _shipment;
    private bool _isLoading = true;
    private bool _isProcessingPayment = false;
    private bool _isStripeInitialized = false;
    private bool _isUploadDialogVisible = false;
    private bool _isUploadFormValid = false;
    private bool _isUploading = false;
    private string _newNote;
    private MudForm _uploadForm;
    private UploadedFile _selectedFile;
    private DocumentType _documentType = DocumentType.Invoice;
    private string _documentNotes;

    protected override async Task OnInitializedAsync()
    {
        await LoadShipmentAsync();
    }

    private async Task LoadShipmentAsync()
    {
        _isLoading = true;

        try
        {
            _shipment = await ShipmentService.GetShipmentByIdAsync(Id);
        }
        catch (Exception ex)
        {
            Snackbar.Add(L["Error loading shipment: "] + ex.Message, Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task UpdateStatus(ShipmentStatus status)
    {
        try
        {
            await ShipmentService.UpdateShipmentStatusAsync(Id, status);
            await LoadShipmentAsync();
            Snackbar.Add(L["Shipment status updated successfully"], Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add(L["Error updating status: "] + ex.Message, Severity.Error);
        }
    }

    private async Task InitiatePayment()
    {
        _isProcessingPayment = true;

        try
        {
            var clientSecret = await StripeService.CreatePaymentIntentAsync(Id);
            var publicKey = StripeService.GetPublicKey();

            await JSRuntime.InvokeVoidAsync("initializeStripePayment", clientSecret, publicKey, "payment-element-container", NavigationManager.Uri);
            _isStripeInitialized = true;
        }
        catch (Exception ex)
        {
            Snackbar.Add(L["Error initializing payment: "] + ex.Message, Severity.Error);
        }
        finally
        {
            _isProcessingPayment = false;
        }
    }

    private void OpenUploadDialog()
    {
        _selectedFile = null;
        _documentType = DocumentType.Invoice;
        _documentNotes = "";
        _isUploadDialogVisible = true;
    }

    private void OnInputFileChange(InputFileChangeEventArgs e)
    {
        var res = ConvertToUploadedFile(e.File);
        _selectedFile = res;
    }

    private UploadedFile ConvertToUploadedFile(IBrowserFile file)
    {
        // Puedes definir un límite de tamaño para el stream si es necesario, por ejemplo: file.OpenReadStream(1024 * 1024 * 15) para 15MB
        return new UploadedFile
            {
                FileStream = file.OpenReadStream(file.Size), // O bien, especifica un límite de tamaño máximo
                FileName = file.Name,
                ContentType = file.ContentType,
                Size = file.Size
            };
    }
    
    private async Task UploadDocument()
    {
        if (_selectedFile == null)
        {
            return;
        }
        
        _isUploading = true;
        
        try
        {
            await ShipmentService.UploadDocumentAsync(Id, _selectedFile, _documentType, _documentNotes);
            _isUploadDialogVisible = false;
            await LoadShipmentAsync();
            Snackbar.Add(L["Document uploaded successfully"], Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add(L["Error uploading document: "] + ex.Message, Severity.Error);
        }
        finally
        {
            _isUploading = false;
        }
    }
    
    private async Task AddNote()
    {
        if (string.IsNullOrWhiteSpace(_newNote))
        {
            return;
        }
        
        try
        {
            // Call a service to add a note
            // For simplicity, we'll just reload the shipment
            _newNote = "";
            await LoadShipmentAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add(L["Error adding note: "] + ex.Message, Severity.Error);
        }
    }
    
    private async Task CopyTrackingNumber()
    {
        await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", _shipment.TrackingNumber);
        Snackbar.Add(L["Tracking number copied to clipboard"], Severity.Success);
    }
    
    private string GetDocumentTypeName(DocumentType type) => type switch
    {
        DocumentType.Invoice => L["Invoice"],
        DocumentType.PaymentProof => L["PaymentProof"],
        DocumentType.ProductImage => L["ProductImage"],
        DocumentType.ShippingLabel => L["ShippingLabel"],
        DocumentType.CustomsDeclaration => L["CustomsDeclaration"],
        DocumentType.OtherDocumentation => L["OtherDocumentation"],
        _ => type.ToString()
    };
    
    private Color GetTimelineColor(ShipmentStatus status) => status switch
    {
        ShipmentStatus.Draft => Color.Default,
        ShipmentStatus.Submitted => Color.Info,
        ShipmentStatus.AwaitingDocuments => Color.Warning,
        ShipmentStatus.DocumentsReviewed => Color.Info,
        ShipmentStatus.AwaitingPayment => Color.Warning,
        ShipmentStatus.AwaitingArrival => Color.Info,
        ShipmentStatus.ReceivedInWarehouse => Color.Info,
        ShipmentStatus.Processing => Color.Info,
        ShipmentStatus.InTransit => Color.Primary,
        ShipmentStatus.InDelivery => Color.Primary,
        ShipmentStatus.Delivered => Color.Success,
        ShipmentStatus.Exception => Color.Error,
        ShipmentStatus.Cancelled => Color.Error,
        _ => Color.Default
    };
    
    private string GetStatusText(ShipmentStatus status) => status switch
    {
        ShipmentStatus.Draft => L["StatusDraft"],
        ShipmentStatus.Submitted => L["StatusSubmitted"],
        ShipmentStatus.AwaitingDocuments => L["StatusAwaitingDocuments"],
        ShipmentStatus.DocumentsReviewed => L["StatusDocumentsReviewed"],
        ShipmentStatus.AwaitingPayment => L["StatusAwaitingPayment"],
        ShipmentStatus.AwaitingArrival => L["StatusAwaitingArrival"],
        ShipmentStatus.ReceivedInWarehouse => L["StatusReceivedInWarehouse"],
        ShipmentStatus.Processing => L["StatusProcessing"],
        ShipmentStatus.InTransit => L["StatusInTransit"],
        ShipmentStatus.InDelivery => L["StatusInDelivery"],
        ShipmentStatus.Delivered => L["StatusDelivered"],
        ShipmentStatus.Exception => L["StatusException"],
        ShipmentStatus.Cancelled => L["StatusCancelled"],
        _ => status.ToString()
    };
}
